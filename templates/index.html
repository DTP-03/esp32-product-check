<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Inspection</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        img {
            width: 100%;
            max-width: 500px;
            height: auto;
        }
        .status {
            font-size: 1.5em;
        }
        .status-waiting {
            color: gray;
        }
        .status-ok {
            color: green;
        }
        .status-error {
            color: red;
        }
        .mode {
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Hệ Thống Phân Loại Sản Phẩm</h1>
    
    <!-- Hiển thị ảnh và trạng thái sản phẩm -->
    <div>
        <h2>Sản Phẩm Mới Nhất</h2>
        <img id="latest-image" src="static/latest1.jpg?t={{ time }}" alt="Latest Product Image">
        <p id="status" class="status status-waiting">Status: WAITING</p>
        <p id="timestamp">Timestamp: </p>
    </div>

    <!-- Điều khiển hệ thống -->
    <div>
        <h2>Điều Khiển Hệ Thống</h2>
        <div>
            <label for="mode">Mode: </label>
            <button id="mode-auto">Auto</button>
            <button id="mode-manual">Manual</button>
        </div>
        <div id="manual-controls" style="display:none;">
            <button id="result-ok">OK</button>
            <button id="result-error">ERROR</button>
        </div>
        <div id="system-control">
            <button id="stop-system">Stop System</button>
            <button id="start-system" style="display:none;">Start System</button>
        </div>
    </div>

    <!-- Danh sách ảnh đã lưu -->
    <div>
        <h2>Danh sách ảnh sản phẩm</h2>
        <div id="image-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
            <!-- Ảnh sẽ được load từ JS -->
        </div>
    </div>


    <script>
        $(document).ready(function() {
            // Tự động cập nhật ảnh và trạng thái
            function updateStatus() {
                $.get('/status', function(data) {
                    const time = new Date().getTime();
                    $('#latest-image').attr('src', `static/${data.image}?t=${time}`);
                    $('#status').text(`Status: ${data.status}`).removeClass('status-waiting status-ok status-error').addClass(`status-${data.status.toLowerCase()}`);
                    $('#timestamp').text(`Timestamp: ${data.timestamp}`);
                });

                
                // Hàm hiển thị danh sách ảnh từ Cloudinary
            function loadImageList() {
                $.get('/images', function(data) {
                    $('#image-list').empty();
                    data.forEach(img => {
                        const tag = img.tags.includes("ERROR") ? "❌ ERROR" : "✅ OK";
                        const tagColor = img.tags.includes("ERROR") ? "red" : "green";
                        const time = new Date(img.created_at).toLocaleString();
            
                        const html = `
                            <div style="border: 1px solid #ccc; padding: 10px; border-radius: 8px;">
                                <img src="${img.url}" alt="Product Image" style="width: 100%; border-radius: 6px;" />
                                <p style="color: ${tagColor}; font-weight: bold; margin-top: 5px;">${tag}</p>
                                <p style="font-size: 0.8em; color: gray;">${time}</p>
                            </div>
                        `;
                        $('#image-list').append(html);
                    });
                });
            }

           
            

                // Cập nhật trạng thái băng tải
                $.get('/bangtai', function(data) {
                    if (data.Bangtai === "STOP") {
                        $('#stop-system').hide();
                        $('#start-system').show();
                    } else {
                        $('#stop-system').show();
                        $('#start-system').hide();
                    }
                });
            }

            // Cập nhật trạng thái mỗi 5 giây
            setInterval(updateStatus, 5000);
            updateStatus(); // Cập nhật lần đầu
            // Tải danh sách ảnh sau khi trang load
            loadImageList();
            // Thay đổi chế độ
            $('#mode-auto').click(function() {
                $.ajax({
                    url: '/set-mode',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ mode: 'auto' }),
                    success: function() {
                        $('#mode-auto').prop('disabled', true);
                        $('#mode-manual').prop('disabled', false);
                        $('#manual-controls').hide();
                    }
                });
            });

            $('#mode-manual').click(function() {
                $.ajax({
                    url: '/set-mode',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ mode: 'manual' }),
                    success: function() {
                        $('#mode-auto').prop('disabled', false);
                        $('#mode-manual').prop('disabled', true);
                        $('#manual-controls').show();
                    }
                });
            });

            // Gửi kết quả thủ công
            $('#result-ok').click(function() {
                $.ajax({
                    url: '/manual-result',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ result: 'OK' }),
                    success: function() {
                        alert('Result submitted: OK');
                    }
                });
            });

            $('#result-error').click(function() {
                $.ajax({
                    url: '/manual-result',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ result: 'ERROR' }),
                    success: function() {
                        alert('Result submitted: ERROR');
                    }
                });
            });

            // Dừng/Khởi động hệ thống
            $('#stop-system').click(function() {
                $.ajax({
                    url: '/set-bangtai',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ Bangtai: 'STOP' }),
                    success: function() {
                        $('#stop-system').hide();
                        $('#start-system').show();
                    }
                });
            });

            $('#start-system').click(function() {
                $.ajax({
                    url: '/set-bangtai',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ Bangtai: 'START' }),
                    success: function() {
                        $('#stop-system').show();
                        $('#start-system').hide();
                    }
                });
            });
        });
    </script>
</body>
</html>
